<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reachy Mini - Blockly Controller</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/blockly/10.4.3/blockly.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/acorn/8.11.3/acorn.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f1a;
      color: #e0e0e0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    header h1 { font-size: 1.3rem; display: flex; align-items: center; gap: 8px; }
    .status { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .status-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: #ef4444;
      transition: all 0.3s;
    }
    .status-dot.connected { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
    .controls { display: flex; gap: 8px; margin-left: auto; flex-wrap: wrap; }
    button {
      background: rgba(255,255,255,0.15);
      color: white;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }
    button:hover { background: rgba(255,255,255,0.25); transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button.primary { background: #22c55e; border-color: #16a34a; }
    button.primary:hover { background: #16a34a; }
    button.danger { background: #ef4444; border-color: #dc2626; }
    button.danger:hover { background: #dc2626; }
    main { flex: 1; display: flex; overflow: hidden; }
    #blocklyDiv { flex: 1; height: 100%; }
    .sidebar {
      width: 340px;
      background: #1a1a2e;
      border-left: 1px solid #2a2a4a;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 10px 14px;
      background: #232340;
      font-weight: 600;
      font-size: 12px;
      color: #888;
      border-bottom: 1px solid #2a2a4a;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .code-output {
      flex: 1;
      padding: 12px;
      overflow: auto;
      font-family: 'SF Mono', 'Fira Code', Consolas, monospace;
      font-size: 11px;
      line-height: 1.5;
      white-space: pre-wrap;
      color: #a0a0c0;
      background: #12121f;
    }
    .console { flex: 1; border-top: 1px solid #2a2a4a; display: flex; flex-direction: column; min-height: 150px; }
    .console-output {
      flex: 1; padding: 10px; overflow-y: auto;
      font-family: 'SF Mono', 'Fira Code', Consolas, monospace;
      font-size: 11px;
      background: #0a0a14;
    }
    .console-output div { padding: 2px 0; border-bottom: 1px solid #1a1a2a; }
    .console-output .log { color: #a0a0c0; }
    .console-output .error { color: #f87171; }
    .console-output .success { color: #4ade80; }
    .console-output .warn { color: #fbbf24; }
    .console-output .info { color: #60a5fa; }
    .motor-status {
      padding: 10px;
      background: #12121f;
      border-bottom: 1px solid #2a2a4a;
      font-size: 11px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }
    .motor-badge {
      background: #232340;
      padding: 4px 8px;
      border-radius: 4px;
      text-align: center;
    }
    .motor-badge.active { background: #22c55e33; border: 1px solid #22c55e; }
    .motor-badge.error { background: #ef444433; border: 1px solid #ef4444; color: #f87171; }
    .motor-badge span { display: block; font-size: 10px; color: #666; }
    .tabs { display: flex; background: #232340; }
    .tab {
      flex: 1;
      padding: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 12px;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }
    .tab:hover { background: #2a2a50; }
    .tab.active { border-bottom-color: #667eea; color: #667eea; }
    .tab-content { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .tab-content.active { display: flex; }

    /* Blockly toolbox text fix */
    .blocklyTreeLabel, .blocklyToolboxCategory {
      color: #000000 !important;
    }
    .blocklyTreeRow:hover {
      background-color: rgba(255,255,255,0.1) !important;
    }

    /* AI Assistant Styles */
    .ai-assistant {
      height: 250px;
      border-top: 2px solid #667eea;
      display: flex;
      flex-direction: column;
      background: #12121f;
    }
    .ai-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: #232340;
      border-bottom: 1px solid #2a2a4a;
    }
    .ai-header-title {
      font-size: 12px;
      font-weight: 600;
      color: #667eea;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .ai-settings-btn {
      background: transparent;
      border: 1px solid #444;
      color: #888;
      padding: 4px 8px;
      font-size: 11px;
      cursor: pointer;
      border-radius: 4px;
    }
    .ai-settings-btn:hover {
      background: #333;
      color: #fff;
    }
    .ai-chat {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      font-size: 12px;
    }
    .ai-message {
      margin-bottom: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      max-width: 90%;
    }
    .ai-message.user {
      background: #3a3a5a;
      margin-left: auto;
      color: #e0e0e0;
    }
    .ai-message.assistant {
      background: #1e3a5f;
      color: #a0d0ff;
    }
    .ai-message.error {
      background: #5f1e1e;
      color: #ffa0a0;
    }
    .ai-message.system {
      background: #2a2a4a;
      color: #888;
      font-style: italic;
      text-align: center;
      max-width: 100%;
    }
    .ai-message.code {
      background: #1a1a2e;
      border: 1px solid #3a3a5a;
      font-family: 'SF Mono', 'Fira Code', Consolas, monospace;
      font-size: 11px;
      white-space: pre-wrap;
      color: #a0d0ff;
      max-width: 100%;
      overflow-x: auto;
    }
    .ai-input-area {
      display: flex;
      gap: 8px;
      padding: 10px;
      background: #1a1a2e;
      border-top: 1px solid #2a2a4a;
    }
    .ai-input {
      flex: 1;
      background: #232340;
      border: 1px solid #3a3a5a;
      color: #e0e0e0;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      outline: none;
    }
    .ai-input:focus {
      border-color: #667eea;
    }
    .ai-input::placeholder {
      color: #666;
    }
    .ai-send-btn {
      background: #667eea;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
    }
    .ai-send-btn:hover {
      background: #5a6fd6;
    }
    .ai-send-btn:disabled {
      background: #444;
      cursor: not-allowed;
    }
    .ai-thinking {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 8px 12px;
      color: #888;
      font-size: 12px;
    }
    .ai-thinking-dots {
      display: flex;
      gap: 3px;
    }
    .ai-thinking-dots span {
      width: 6px;
      height: 6px;
      background: #667eea;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out both;
    }
    .ai-thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
    .ai-thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
    .ai-thinking-dots span:nth-child(3) { animation-delay: 0s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* AI Settings Modal */
    .ai-settings-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .ai-settings-modal.show {
      display: flex;
    }
    .ai-settings-content {
      background: #1a1a2e;
      border: 1px solid #3a3a5a;
      border-radius: 12px;
      padding: 20px;
      width: 400px;
      max-width: 90%;
    }
    .ai-settings-content h3 {
      margin: 0 0 16px 0;
      color: #667eea;
      font-size: 16px;
    }
    .ai-settings-group {
      margin-bottom: 14px;
    }
    .ai-settings-group label {
      display: block;
      font-size: 12px;
      color: #888;
      margin-bottom: 4px;
    }
    .ai-settings-group select,
    .ai-settings-group input {
      width: 100%;
      background: #232340;
      border: 1px solid #3a3a5a;
      color: #e0e0e0;
      padding: 8px 10px;
      border-radius: 6px;
      font-size: 12px;
    }
    .ai-settings-group input::placeholder {
      color: #555;
    }
    .ai-settings-buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 16px;
    }
    .ai-settings-buttons button {
      padding: 8px 16px;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <header>
    <h1>ü§ñ Reachy Mini</h1>
    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Disconnected</span>
    </div>
    <div class="controls">
      <button id="connectBtn" onclick="toggleConnection()">üîå Connect</button>
      <button onclick="checkMotors()">üîç Check</button>
      <button onclick="enableAllTorque()">‚ö° Enable All</button>
      <button onclick="disableAllTorque()">üí§ Disable All</button>
      <button onclick="rebootAllMotors()">üîÑ Reboot All</button>
      <button class="primary" onclick="runCode()">‚ñ∂ Run</button>
      <button class="danger" onclick="stopCode()">‚¨õ Stop</button>
      <button onclick="saveWorkspace()">üíæ Save</button>
      <button onclick="loadWorkspace()">üìÇ Load</button>
    </div>
  </header>

  <main>
    <div id="blocklyDiv"></div>
    <div class="sidebar">
      <div class="sidebar-header">Motor Status</div>
      <div class="motor-status" id="motorStatus">
        <div class="motor-badge" id="motor11">M11<span>--</span></div>
        <div class="motor-badge" id="motor12">M12<span>--</span></div>
        <div class="motor-badge" id="motor13">M13<span>--</span></div>
        <div class="motor-badge" id="motor14">M14<span>--</span></div>
        <div class="motor-badge" id="motor15">M15<span>--</span></div>
        <div class="motor-badge" id="motor16">M16<span>--</span></div>
        <div class="motor-badge" id="motor17">M17<span>--</span></div>
        <div class="motor-badge" id="motor18">M18<span>--</span></div>
      </div>
      <div class="tabs">
        <div class="tab" onclick="switchTab('code')">Code</div>
        <div class="tab active" onclick="switchTab('console')">Console</div>
      </div>
      <div class="tab-content" id="codeTab">
        <div class="sidebar-header" style="display: flex; justify-content: space-between; align-items: center;">
          <span>Generated Code</span>
          <select id="languageSelect" style="background: #333; border: 1px solid #555; color: #ccc; padding: 2px 6px; font-size: 10px; border-radius: 3px;" onchange="updateCodeOutput()">
            <option value="javascript">JavaScript</option>
            <option value="python">Python</option>
          </select>
        </div>
        <div class="code-output" id="codeOutput">// Drag blocks here...</div>
      </div>
      <div class="tab-content active" id="consoleTab">
        <div class="sidebar-header">Console Output</div>
        <div class="console-output" id="consoleOutput"></div>
      </div>

      <!-- AI Assistant Panel -->
      <div class="ai-assistant">
        <div class="ai-header">
          <div class="ai-header-title">
            <span>AI Assistant</span>
            <select id="aiProviderSelect" style="background: #333; border: 1px solid #555; color: #ccc; padding: 2px 6px; font-size: 10px; border-radius: 3px;">
              <option value="anthropic">Claude</option>
              <option value="openai">OpenAI</option>
              <option value="ollama">Ollama (Local)</option>
            </select>
          </div>
          <button class="ai-settings-btn" onclick="openAISettings()">Settings</button>
        </div>
        <div class="ai-chat" id="aiChat">
          <div class="ai-message system">Ask the AI to help edit your Blockly workspace</div>
        </div>
        <div class="ai-input-area">
          <input type="text" class="ai-input" id="aiInput" placeholder="Describe what you want to build..." onkeypress="if(event.key==='Enter')sendAIMessage()">
          <button class="ai-send-btn" id="aiSendBtn" onclick="sendAIMessage()">Send</button>
        </div>
      </div>
    </div>
  </main>

  <!-- AI Settings Modal -->
  <div class="ai-settings-modal" id="aiSettingsModal" onclick="if(event.target===this)closeAISettings()">
    <div class="ai-settings-content">
      <h3>AI Settings</h3>
      <div class="ai-settings-group">
        <label>Provider</label>
        <select id="settingsProvider" onchange="updateSettingsUI()">
          <option value="anthropic">Claude (Anthropic)</option>
          <option value="openai">OpenAI</option>
          <option value="ollama">Ollama (Local)</option>
        </select>
      </div>
      <div class="ai-settings-group" id="endpointGroup">
        <label>Endpoint URL</label>
        <input type="text" id="settingsEndpoint" placeholder="http://localhost:11434">
      </div>
      <div class="ai-settings-group" id="apiKeyGroup" style="display: none;">
        <label>API Key</label>
        <input type="password" id="settingsApiKey" placeholder="sk-...">
      </div>
      <div class="ai-settings-group">
        <label>Model</label>
        <input type="text" id="settingsModel" placeholder="llama3.2">
      </div>
      <div class="ai-settings-buttons">
        <button onclick="closeAISettings()">Cancel</button>
        <button class="primary" onclick="saveAISettings()">Save</button>
      </div>
    </div>
  </div>

  <!-- Comprehensive Toolbox -->
  <xml id="toolbox" style="display: none">
    <!-- Robot Connection -->
    <category name="üîå Connection" colour="260">
      <block type="enable_torque"></block>
      <block type="disable_torque"></block>
      <block type="enable_all"></block>
      <block type="disable_all"></block>
      <block type="check_joints"></block>
      <block type="ping_joint"></block>
      <block type="reboot_joint"></block>
      <block type="reboot_all"></block>
    </category>

    <!-- Antennas (Motors 17-18) -->
    <category name="üì° Antennas" colour="160">
      <block type="set_degrees">
        <value name="DEGREES"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
      </block>
      <block type="get_degrees"></block>
      <block type="move_by">
        <value name="AMOUNT"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
      </block>
    </category>

    <!-- Head (Motors 11-16) -->
    <category name="ü§ñ Head" colour="180">
      <block type="get_head_coordinates"></block>
      <block type="set_head_coordinates"></block>
    </category>

    <!-- Coordinates -->
    <category name="üìê Coordinates" colour="290">
      <block type="create_coordinates">
        <value name="X"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="Y"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="Z"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="ROLL"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="PITCH"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="YAW"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
      </block>
      <block type="get_coordinate"></block>
    </category>

    <!-- Sensing -->
    <category name="üì° Sensing" colour="210">
      <block type="is_moving"></block>
      <block type="wait_until_stopped">
        <value name="TIMEOUT"><shadow type="math_number"><field name="NUM">5</field></shadow></value>
      </block>
      <block type="get_load"></block>
      <block type="get_temperature"></block>
      <block type="joint_in_range">
        <value name="MIN"><shadow type="math_number"><field name="NUM">-45</field></shadow></value>
        <value name="MAX"><shadow type="math_number"><field name="NUM">45</field></shadow></value>
      </block>
    </category>

    <!-- Timing -->
    <category name="‚è±Ô∏è Timing" colour="120">
      <block type="wait">
        <value name="TIME"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
      </block>
      <block type="wait_ms">
        <value name="TIME"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
      </block>
      <block type="get_time"></block>
      <block type="reset_timer"></block>
      <block type="timer_value"></block>
    </category>

    <!-- Output -->
    <category name="üìù Output" colour="60">
      <block type="log">
        <value name="MESSAGE"><shadow type="text"><field name="TEXT">Hello!</field></shadow></value>
      </block>
      <block type="log_joint"></block>
      <block type="log_type"></block>
      <block type="alert">
        <value name="MESSAGE"><shadow type="text"><field name="TEXT">Hello!</field></shadow></value>
      </block>
    </category>

    <sep></sep>

    <!-- Logic (Built-in) -->
    <category name="üîÄ Logic" colour="210">
      <block type="controls_if"></block>
      <block type="controls_if">
        <mutation else="1"></mutation>
      </block>
      <block type="controls_if">
        <mutation elseif="1" else="1"></mutation>
      </block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
      <block type="logic_ternary"></block>
    </category>

    <!-- Loops (Built-in) -->
    <category name="üîÅ Loops" colour="120">
      <block type="controls_repeat_ext">
        <value name="TIMES"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
      </block>
      <block type="controls_whileUntil"></block>
      <block type="controls_for">
        <value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
        <value name="TO"><shadow type="math_number"><field name="NUM">10</field></shadow></value>
        <value name="BY"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
      </block>
      <block type="controls_forEach"></block>
      <block type="controls_flow_statements"></block>
    </category>

    <!-- Math (Built-in) -->
    <category name="üî¢ Math" colour="230">
      <block type="math_number"><field name="NUM">0</field></block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
      <block type="math_trig"></block>
      <block type="math_constant"></block>
      <block type="math_number_property"></block>
      <block type="math_round"></block>
      <block type="math_on_list"></block>
      <block type="math_modulo"></block>
      <block type="math_constrain">
        <value name="LOW"><shadow type="math_number"><field name="NUM">0</field></shadow></value>
        <value name="HIGH"><shadow type="math_number"><field name="NUM">4095</field></shadow></value>
      </block>
      <block type="math_random_int">
        <value name="FROM"><shadow type="math_number"><field name="NUM">1</field></shadow></value>
        <value name="TO"><shadow type="math_number"><field name="NUM">100</field></shadow></value>
      </block>
      <block type="math_random_float"></block>
      <block type="math_atan2"></block>
    </category>

    <!-- Text (Built-in) -->
    <category name="üìÑ Text" colour="160">
      <block type="text"></block>
      <block type="text_join"></block>
      <block type="text_append">
        <value name="TEXT"><shadow type="text"></shadow></value>
      </block>
      <block type="text_length"></block>
      <block type="text_isEmpty"></block>
      <block type="text_indexOf"></block>
      <block type="text_charAt"></block>
      <block type="text_getSubstring"></block>
      <block type="text_changeCase"></block>
      <block type="text_trim"></block>
      <block type="text_prompt_ext">
        <value name="TEXT"><shadow type="text"><field name="TEXT">Enter value:</field></shadow></value>
      </block>
    </category>

    <!-- Lists (Built-in) -->
    <category name="üìã Lists" colour="260">
      <block type="lists_create_empty"></block>
      <block type="lists_create_with"></block>
      <block type="lists_repeat">
        <value name="NUM"><shadow type="math_number"><field name="NUM">5</field></shadow></value>
      </block>
      <block type="lists_length"></block>
      <block type="lists_isEmpty"></block>
      <block type="lists_indexOf"></block>
      <block type="lists_getIndex"></block>
      <block type="lists_setIndex"></block>
      <block type="lists_getSublist"></block>
      <block type="lists_split">
        <value name="DELIM"><shadow type="text"><field name="TEXT">,</field></shadow></value>
      </block>
      <block type="lists_sort"></block>
      <block type="lists_reverse"></block>
    </category>

    <!-- Variables (Built-in) -->
    <category name="üì¶ Variables" colour="330" custom="VARIABLE"></category>

    <!-- Functions (Built-in) -->
    <category name="üß© Functions" colour="290" custom="PROCEDURE"></category>
  </xml>

  <script src="index.js"></script>
  <script src="blockly-app.js"></script>
</body>
</html>
